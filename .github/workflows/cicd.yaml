  verify-monitoring:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Google Cloud Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          create_credentials_file: true
          export_environment_variables: true
          universe: googleapis.com
          cleanup_credentials: true

      - name: Install GKE Auth Plugin
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin

      - name: Set GKE Context to Connect to Cluster
        run: |
          gcloud container clusters get-credentials flasksql-cluster --project terraflaskqlk8s --zone us-east1-b

      - name: Install Helm and Add Prometheus Repo
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts/
          helm repo update

      - name: Verify Monitoring Is Up & Running
        run: |
          set -x
          if kubectl get pods -n monitor | grep -qi grafana; then
            echo "Monitor stack is up & running."
          else
            helm install my-monitoring prometheus-community/kube-prometheus-stack -n monitor
          fi
